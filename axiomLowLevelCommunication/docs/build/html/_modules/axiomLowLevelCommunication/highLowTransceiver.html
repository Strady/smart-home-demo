
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>axiomLowLevelCommunication.highLowTransceiver &#8212; документация функциональный модуль &#34;Взаимодействие с низким уровнем&#34; 0.1</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Алфавитный указатель" href="../../genindex.html" />
    <link rel="search" title="Поиск" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Навигация</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Алфавитный указатель"
             accesskey="I">указатель</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">документация функциональный модуль &#34;Взаимодействие с низким уровнем&#34; 0.1</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Код модуля</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Исходный код axiomLowLevelCommunication.highLowTransceiver</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">ujson</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">from</span> <span class="nn">.serialTransceiver</span> <span class="k">import</span> <span class="n">SerialTransceiver</span>
<span class="c1"># from axiomLowLevelCommunication import logger</span>
<span class="kn">from</span> <span class="nn">apscheduler.schedulers.background</span> <span class="k">import</span> <span class="n">BackgroundScheduler</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>


<div class="viewcode-block" id="HighLowTransceiver"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver">[документация]</a><span class="k">class</span> <span class="nc">HighLowTransceiver</span><span class="p">:</span>

<div class="viewcode-block" id="HighLowTransceiver.__init__"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.__init__">[документация]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Инициализирует экземпляр класса</span>

<span class="sd">        :ivar settings: конфигурация аппаратных модулей системы</span>
<span class="sd">        :ivar redis: объект подключения к БД Redis</span>
<span class="sd">        :ivar isRunning: флаг работы/остановки</span>
<span class="sd">        :ivar power_unit_addrs: список адресов силовых модулей</span>
<span class="sd">        :ivar input_unit_addrs: список адресов модулей ввода</span>
<span class="sd">        :ivar unit_addrs_to_transceivers_map: таблица соответствия адресов модулей объектам</span>
<span class="sd">         :class:`~axiomLowLevelCommunication.serialTransceiver.SerialTransceiver`, подключенным к COM портам, соответствующего модуля</span>
<span class="sd">        :ivar power_units_state_dicts: структура состояния силовых модулей</span>
<span class="sd">        :ivar input_units_state_dicts: структура состояния модулей ввода</span>
<span class="sd">        :ivar power_units_maintenance: флаги силовых модулей обслуживание/штатная работа</span>
<span class="sd">        :ivar humanreadable_states: таблица соответствия цифровых кодов состояний силовых модулей и их словесного описания</span>
<span class="sd">        :ivar humanreadable_signals: таблица соответствия цифровых кодов сигналов силовых модулей и их словесного описания</span>
<span class="sd">        :ivar ch_locks: словарь с объектами блокировки управления каналами силовых модулей</span>
<span class="sd">        :ivar scheduler: планировщик задач</span>
<span class="sd">        :ivar Crc8Table: таблица для рассчета контрольных сумм CRC8 табличным способом</span>
<span class="sd">        :ivar pu_regex: шаблон регулярного выражения для парсинга посылок от силовых модулей</span>
<span class="sd">        :ivar iu_regex: шаблон регулярного выражения для парсинга посылок от модулей ввода</span>
<span class="sd">        :ivar P_passive: мощность потребляемая системой без учета подключенных к ней потребителей</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Загружаем настройки</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_settings</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Подключаемся к брокеру</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Флаг для остановки потоков чтения/записи</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isRunning</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Привязка адресов модулей ввода к адресам силовых модулей</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardware_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;hardware units&#39;</span><span class="p">]</span>

        <span class="c1"># список силовых модулей</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_unit_addrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;power units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># список модулей ввода</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_unit_addrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;input units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># таблица соответствия адресов модулей и объектов трансиверов</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Подключаемся к com порту каждого силового модуля</span>
        <span class="k">for</span> <span class="n">power_unit_addr</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;power units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SerialTransceiver</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="c1"># Подключаемся к com порту каждого модуля ввода</span>
        <span class="k">for</span> <span class="n">input_unit_addr</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;input units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">input_unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">SerialTransceiver</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">input_unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">input_unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="c1"># Создаем структуру состояния для каждого силового модуля</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">power_unit_addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_unit_addrs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;st&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;state1&#39;</span><span class="p">,</span> <span class="s1">&#39;state2&#39;</span><span class="p">,</span> <span class="s1">&#39;signal1&#39;</span><span class="p">,</span> <span class="s1">&#39;signal2&#39;</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">,</span> <span class="s1">&#39;cnt&#39;</span><span class="p">),</span>
                                                        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">power_unit_addr</span><span class="p">),</span> <span class="kc">None</span><span class="p">))},</span>
                <span class="s1">&#39;adc&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;sample1&#39;</span><span class="p">,</span> <span class="s1">&#39;sample2&#39;</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">,</span> <span class="s1">&#39;cnt&#39;</span><span class="p">),</span>
                                                         <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">power_unit_addr</span><span class="p">),</span> <span class="kc">None</span><span class="p">))},</span>
                <span class="s1">&#39;ld&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;load1&#39;</span><span class="p">,</span> <span class="s1">&#39;load2&#39;</span><span class="p">,</span> <span class="s1">&#39;angle1&#39;</span><span class="p">,</span> <span class="s1">&#39;angle2&#39;</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">,</span> <span class="s1">&#39;cnt&#39;</span><span class="p">),</span>
                                                        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">power_unit_addr</span><span class="p">),</span> <span class="kc">None</span><span class="p">))},</span>
                <span class="s1">&#39;tmpr&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;temp1&#39;</span><span class="p">,</span> <span class="s1">&#39;temp2&#39;</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">,</span> <span class="s1">&#39;cnt&#39;</span><span class="p">),</span>
                                                        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">power_unit_addr</span><span class="p">),</span> <span class="kc">None</span><span class="p">))},</span>
                <span class="s1">&#39;isol&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;isol1&#39;</span><span class="p">,</span> <span class="s1">&#39;isol2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))}</span>
            <span class="p">}</span>

        <span class="c1"># Создаем структуру состояния для каждого модуля ввода</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_units_state_dicts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">input_unit_addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_unit_addrs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_units_state_dicts</span><span class="p">[</span><span class="n">input_unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;st&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_unit_addr</span><span class="p">),</span> <span class="s1">&#39;cnt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                <span class="s1">&#39;volt&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Vin&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_unit_addr</span><span class="p">),</span> <span class="s1">&#39;cnt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                <span class="s1">&#39;cur&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Iin&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Iout&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Iypr&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_unit_addr</span><span class="p">),</span> <span class="s1">&#39;cnt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="p">}</span>

        <span class="c1"># Флаг, показывающий, что модуль находится в режиме обслуживания/монтажа</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_units_maintenance</span> <span class="o">=</span> <span class="p">{</span><span class="n">power_unit_addr</span><span class="p">:</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">power_unit_addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_unit_addrs</span><span class="p">}</span>

        <span class="c1"># Обозначения состояний каналов для записи в лог</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="s1">&#39;Начальное состояние&#39;</span><span class="p">,</span>
            <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="s1">&#39;Диагностика силовых узлов&#39;</span><span class="p">,</span>
            <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="s1">&#39;Неисправность канала&#39;</span><span class="p">,</span>
            <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="s1">&#39;Ожидается конфигурация&#39;</span><span class="p">,</span>
            <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="s1">&#39;Выключен&#39;</span><span class="p">,</span>
            <span class="s1">&#39;5&#39;</span><span class="p">:</span> <span class="s1">&#39;Включен&#39;</span><span class="p">,</span>
            <span class="s1">&#39;6&#39;</span><span class="p">:</span> <span class="s1">&#39;Обесточен&#39;</span><span class="p">,</span>
            <span class="s1">&#39;7&#39;</span><span class="p">:</span> <span class="s1">&#39;Сработала защита по КЗ или утечке тока&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># Обозначения сигналов перехода в состояние для записи в лог</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_signals</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="s1">&#39;Сигнал начального состояния&#39;</span><span class="p">,</span>
            <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="s1">&#39;Сигнал к началу работы КАС&#39;</span><span class="p">,</span>
            <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="s1">&#39;Отсутствие конфигурации&#39;</span><span class="p">,</span>
            <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="s1">&#39;Неисправность канала&#39;</span><span class="p">,</span>
            <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="s1">&#39;Неисправность входного реле&#39;</span><span class="p">,</span>
            <span class="s1">&#39;5&#39;</span><span class="p">:</span> <span class="s1">&#39;Неисправность выходного реле&#39;</span><span class="p">,</span>
            <span class="s1">&#39;6&#39;</span><span class="p">:</span> <span class="s1">&#39;Неисправность семистра&#39;</span><span class="p">,</span>
            <span class="s1">&#39;7&#39;</span><span class="p">:</span> <span class="s1">&#39;Короткое замыкание&#39;</span><span class="p">,</span>
            <span class="s1">&#39;8&#39;</span><span class="p">:</span> <span class="s1">&#39;Неисправность в процессе работы&#39;</span><span class="p">,</span>
            <span class="s1">&#39;9&#39;</span><span class="p">:</span> <span class="s1">&#39;Получена ожидаемая конфигурация&#39;</span><span class="p">,</span>
            <span class="s1">&#39;10&#39;</span><span class="p">:</span> <span class="s1">&#39;Нажатие кнопки&#39;</span><span class="p">,</span>
            <span class="s1">&#39;11&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
            <span class="s1">&#39;12&#39;</span><span class="p">:</span> <span class="s1">&#39;Команда включения канала&#39;</span><span class="p">,</span>
            <span class="s1">&#39;13&#39;</span><span class="p">:</span> <span class="s1">&#39;Команда выключения канала&#39;</span><span class="p">,</span>
            <span class="s1">&#39;14&#39;</span><span class="p">:</span> <span class="s1">&#39;Сработала защита по утечке тока&#39;</span><span class="p">,</span>
            <span class="s1">&#39;15&#39;</span><span class="p">:</span> <span class="s1">&#39;Сработала защита по КЗ&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># объекты блокировки управления каналами</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ch_locks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">unit_addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_unit_addrs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]:</span>
                <span class="n">ch_addr</span> <span class="o">=</span> <span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ch_locks</span><span class="p">[</span><span class="n">ch_addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="c1"># Счетчики команд силовых модулей</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_units_counters</span> <span class="o">=</span> <span class="p">{}</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power_unit_addrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Планировщик для отправки на модуль &quot;Логика&quot; текущих значений потребляемой мощности в каналах</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">BackgroundScheduler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">publish_current_characteristics</span><span class="p">,</span> <span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Crc8Table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span>
            <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">,</span>
            <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span>
            <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span>
            <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
            <span class="mh">0x3F</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span>
            <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span>
            <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span>
            <span class="mh">0x3D</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span>
            <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xB5</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
            <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0xBA</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span>
            <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
            <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0xD9</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span>
            <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span>
            <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span>
            <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span>
            <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0xDC</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span>
            <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span>
            <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span>
            <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span>
            <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0xAF</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x6B</span><span class="p">,</span>
            <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0xD2</span><span class="p">,</span>
            <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>
            <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span>
            <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span>
            <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0xCF</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span>
            <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span>
            <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span>
            <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span>
            <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span>
            <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span>
            <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xCE</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0xAC</span>
        <span class="p">])</span>

        <span class="c1"># Регулярные выражения для посылок от модулей ввода и силовых модулей</span>
        <span class="n">pu_st_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;type_st&gt;st) (?P&lt;state1&gt;\d{1,4}) (?P&lt;state2&gt;\d{1,4}) (?P&lt;signal1&gt;\d{1,4}) (?P&lt;signal2&gt;\d{1,4})&#39;</span>
        <span class="c1"># pu_adc_regex = r&#39;(?P&lt;type_adc&gt;adc) (?P&lt;sample1&gt;\d{1,2}\.\d{0,100}) (?P&lt;sample2&gt;\d{1,2}\.\d{0,100}) (?P&lt;freq&gt;\d{0,2})&#39;</span>
        <span class="n">pu_adc_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;type_adc&gt;adc) (?P&lt;sample1&gt;\d{1,2}\.\d{0,100}) (?P&lt;sample2&gt;\d{1,2}\.\d{0,100})&#39;</span>
        <span class="n">pu_tmpr_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;type_tmpr&gt;tmpr) (?P&lt;temp1&gt;\d{1,3}) (?P&lt;temp2&gt;\d{1,3})&#39;</span>
        <span class="n">iu_st_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;type_st&gt;st) (?P&lt;state&gt;\d{1,4}) (?P&lt;signal&gt;\d{1,4})&#39;</span>
        <span class="n">volt_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;type_volt&gt;volt) (?P&lt;Vin&gt;\d{1,3}\.\d{0,100}) (?P&lt;freq&gt;\d{0,2})&#39;</span>
        <span class="n">cur_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;type_cur&gt;cur) (?P&lt;Iin&gt;\d{1,2}\.\d{0,100}) (?P&lt;Iout&gt;\d{1,2}\.\d{0,100}) (?P&lt;Iypr&gt;\d{1,2}\.\d{0,100})&#39;</span>
        <span class="n">iu_adc_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;type_adc&gt;adc) (?P&lt;sample&gt;\d{1,4}) \d{1,4}&#39;</span>
        <span class="n">ld_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;type_ld&gt;ld) (?P&lt;load1&gt;\d{1,4}) (?P&lt;load2&gt;\d{1,4}) (?P&lt;angle1&gt;\d{1,4}) (?P&lt;angle2&gt;\d{1,4})&#39;</span>
        <span class="n">rply_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;reply&gt;(?P&lt;type_rply&gt;rply) .+)&#39;</span>
        <span class="n">counter_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;cnt&gt;\d{1,10})&#39;</span>
        <span class="n">unit_addr_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;addr&gt;</span><span class="si">%s</span><span class="s1">)&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pu_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;((</span><span class="si">{st}</span><span class="s1">|</span><span class="si">{adc}</span><span class="s1">|</span><span class="si">{ld}</span><span class="s1">|</span><span class="si">{tmpr}</span><span class="s1">) </span><span class="si">{cnt}{addr}</span><span class="s1">)|</span><span class="si">{rply}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">st</span><span class="o">=</span><span class="n">pu_st_regex</span><span class="p">,</span>
                                                                                <span class="n">adc</span><span class="o">=</span><span class="n">pu_adc_regex</span><span class="p">,</span>
                                                                                <span class="n">ld</span><span class="o">=</span><span class="n">ld_regex</span><span class="p">,</span>
                                                                                <span class="n">tmpr</span><span class="o">=</span><span class="n">pu_tmpr_regex</span><span class="p">,</span>
                                                                                <span class="n">cnt</span><span class="o">=</span><span class="n">counter_regex</span><span class="p">,</span>
                                                                                <span class="n">addr</span><span class="o">=</span><span class="n">unit_addr_regex</span><span class="p">,</span>
                                                                                <span class="n">rply</span><span class="o">=</span><span class="n">rply_regex</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iu_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;((</span><span class="si">{st}</span><span class="s1">|</span><span class="si">{volt}</span><span class="s1">|</span><span class="si">{cur}</span><span class="s1">) </span><span class="si">{cnt}{addr}</span><span class="s1">)|</span><span class="si">{rply}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">st</span><span class="o">=</span><span class="n">iu_st_regex</span><span class="p">,</span>
                                                                           <span class="n">volt</span><span class="o">=</span><span class="n">volt_regex</span><span class="p">,</span>
                                                                           <span class="n">cur</span><span class="o">=</span><span class="n">cur_regex</span><span class="p">,</span>
                                                                           <span class="n">cnt</span><span class="o">=</span><span class="n">counter_regex</span><span class="p">,</span>
                                                                           <span class="n">addr</span><span class="o">=</span><span class="n">unit_addr_regex</span><span class="p">,</span>
                                                                           <span class="n">rply</span><span class="o">=</span><span class="n">rply_regex</span><span class="p">)</span>

        <span class="c1"># Пассивная потреблямая схемой мощность</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_passive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_passive_consumption</span><span class="p">()</span></div>

<div class="viewcode-block" id="HighLowTransceiver.calc_crc8"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.calc_crc8">[документация]</a>    <span class="k">def</span> <span class="nf">calc_crc8</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">crc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Рассчитывает контрольную сумму по алгоритму CRC8</span>

<span class="sd">        :type buff: numpy.ndarray</span>
<span class="sd">        :param buff: массив с байтами числа</span>
<span class="sd">        :type crc: int</span>
<span class="sd">        :param crc: инициализирующее значение</span>
<span class="sd">        :rtype: numpy.int64</span>
<span class="sd">        :return: рассчитанная контрольная сумма</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">buff</span><span class="p">):</span>
            <span class="n">crc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Crc8Table</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">crc</span> <span class="o">^</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">]))]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">crc</span></div>

<div class="viewcode-block" id="HighLowTransceiver.split_to_bytes"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.split_to_bytes">[документация]</a>    <span class="k">def</span> <span class="nf">split_to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">num_byte</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Представляет число в виде массива байтов, из которых оно состоит</span>
<span class="sd">        :type number: numpy.uint8</span>
<span class="sd">        :param number: исходное число</span>
<span class="sd">        :type num_byte: int</span>
<span class="sd">        :param num_byte: количество байт занимаемых числом</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        :return: массив с байтами числа</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_byte</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_byte</span><span class="p">):</span>
            <span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">buff</span></div>

<div class="viewcode-block" id="HighLowTransceiver.load_settings"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.load_settings">[документация]</a>    <span class="k">def</span> <span class="nf">load_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Загружает настройки ПО из файла с настройками</span>

<span class="sd">        :rtype: dict</span>
<span class="sd">        :return: словарь с настройками</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">default_fname</span> <span class="o">=</span> <span class="s1">&#39;/etc/axiom/settings.json&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AXIOM_SETTINGS&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default_fname</span><span class="p">)</span>
        <span class="c1"># Пытаемся загрузить настройки</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">settings_file</span><span class="p">:</span>
                <span class="n">settings</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">settings_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Если не удается открыть файл</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Ошибка при попытке открыть файл настроек: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Если не удается загрузить настройки из файла</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Ошибка при попытке загрузить настройки из файла настроек: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>

        <span class="c1"># Если не удалось загрузить настройки,</span>
        <span class="c1"># пытаемся загрузить настройки из файла по умолчанию</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span> <span class="ow">and</span> <span class="n">fname</span> <span class="o">!=</span> <span class="n">default_fname</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">default_fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">settings_file</span><span class="p">:</span>
                    <span class="n">settings</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">settings_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Если не удается открыть файл</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Ошибка при попытке открыть файл настроек по умолчанию: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Если не удается загрузить настройки из файла</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Ошибка при попытке загрузить настройки из файла настроек по умолчанию: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">settings</span></div>

<div class="viewcode-block" id="HighLowTransceiver.check_power_unit_counter"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.check_power_unit_counter">[документация]</a>    <span class="k">def</span> <span class="nf">check_power_unit_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">,</span> <span class="n">type_cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Контролирует корректность счетчика в посылке от ПО силового модуля</span>

<span class="sd">        :type counter: str</span>
<span class="sd">        :param counter: значение счетчика</span>
<span class="sd">        :type unit_addr: str</span>
<span class="sd">        :param unit_addr: адрес силового модуля, от которого пришла посылка</span>
<span class="sd">        :type type_cmd: str</span>
<span class="sd">        :param type_cmd: тип посылки</span>

<span class="sd">        .. figure:: _static/check_power_unit_counter.png</span>
<span class="sd">           :scale: 50%</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Если счетчик None, значит модуль до этого не был инициализирован</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="n">type_cmd</span><span class="p">][</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Модуль </span><span class="si">{}</span><span class="s1"> впервые зафиксирован с системе&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_power_unit</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">,))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># Для всех посылок устанавливается максимально возможное значение счетчика,</span>
            <span class="c1"># чтобы избежать повторного запуска инициализации при получении других типов посылок</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;adc&#39;</span><span class="p">][</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;ld&#39;</span><span class="p">][</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;tmpr&#39;</span><span class="p">][</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Если получен нулевой счетчик, а предыдущее значение счетчика не было максимально возможным -</span>
        <span class="c1"># значит модуль перезагрузился и требуется выполнить его инициализацию</span>

        <span class="k">elif</span> <span class="n">counter</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="n">type_cmd</span><span class="p">][</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_maintenance</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;От модуля </span><span class="si">{}</span><span class="s1"> получена посылка со значением счетчика 0. Текущее значение счетчика </span><span class="si">{}</span><span class="s1">.&#39;</span> \
                      <span class="s1">&#39; ПО модуля перезагружалось&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">unit_addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="n">type_cmd</span><span class="p">][</span><span class="s1">&#39;cnt&#39;</span><span class="p">])</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>

            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_power_unit</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">,))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;adc&#39;</span><span class="p">][</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;ld&#39;</span><span class="p">][</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">check_input_unit_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">,</span> <span class="n">type_cmd</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="HighLowTransceiver.on_new_state_parcel"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.on_new_state_parcel">[документация]</a>    <span class="k">def</span> <span class="nf">on_new_state_parcel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parcel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Обрабатывает новые посылки типа &quot;st&quot; от силовых модулей</span>

<span class="sd">        Если состояние какого-либо из каналов силового модуля изменилось то:</span>

<span class="sd">        #. новое состояние публикуется в канал ``axiomLowLevelCommunication:info:state``</span>
<span class="sd">        #. если канал перешел в одно из состояний (&#39;2&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;), то новое состояние сохраняется в Redis</span>
<span class="sd">        #. сообщение о переходе канала в новое состояние пишется в лог</span>

<span class="sd">        :type parcel: dict</span>
<span class="sd">        :param parcel: разобранная посылка от низкого уровня</span>

<span class="sd">        Если состояние одного из каналов &#39;0&#39; и модуль не находится в режиме &quot;обслуживание&quot;,</span>
<span class="sd">        выполняется инициализация модуля</span>

<span class="sd">        .. figure:: _static/on_new_state_parcel.png</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">power_unit_addr</span> <span class="o">=</span> <span class="n">parcel</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span>

        <span class="c1">#TODO переместить эту проверку в конец функции</span>

        <span class="c1"># Случай, когда с модуль был в режиме обслуживания, а потом был из него выведен</span>
        <span class="c1"># Нужно выполнить инициализацию</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">parcel</span><span class="p">[</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="ow">or</span> <span class="n">parcel</span><span class="p">[</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">parcel</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_maintenance</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;инициализируем модуль&#39;</span><span class="p">)</span>

            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;От модуля </span><span class="si">{}</span><span class="s1"> получена посылка с каналом в состоянии &quot;0&quot; (idle) и&#39;</span> \
                      <span class="s1">&#39; значением счетчика отличным от нуля. Требуется выполнить инициализацию модуля&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">power_unit_addr</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_power_unit</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">power_unit_addr</span><span class="p">,))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">):</span>
            <span class="c1"># предыдущее и новое состояния</span>
            <span class="n">prev_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="n">parcel</span><span class="p">[</span><span class="s1">&#39;state</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>

            <span class="c1"># если состояние изменилось</span>
            <span class="k">if</span> <span class="n">prev_state</span> <span class="o">!=</span> <span class="n">new_state</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;axiomLowLevelCommunication:info:state&#39;</span><span class="p">,</span>
                                   <span class="n">message</span><span class="o">=</span><span class="n">ujson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;addr&#39;</span><span class="p">:</span> <span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">power_unit_addr</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                                                    <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">new_state</span><span class="p">}}))</span>
                <span class="c1"># Сохраняем в БД только стабильные состояния</span>
                <span class="c1"># print(&quot;new_state {}&quot;.format(new_state))</span>
                <span class="k">if</span> <span class="n">new_state</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">power_unit_addr</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">new_state</span><span class="p">})</span>
                <span class="c1"># Логируем изменение</span>
                <span class="n">humanreadable_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">new_state</span><span class="p">]</span>
                <span class="n">new_signal</span> <span class="o">=</span> <span class="n">parcel</span><span class="p">[</span><span class="s1">&#39;signal</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
                <span class="n">humanreadable_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_signals</span><span class="p">[</span><span class="n">new_signal</span><span class="p">]</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Выход &quot;</span><span class="si">{}</span><span class="s1">&quot; модуля &quot;</span><span class="si">{}</span><span class="s1">&quot; перешел в состояние &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span> \
                          <span class="s1">&#39; Сигнал перехода: &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">power_unit_addr</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">power_unit_addr</span><span class="p">,</span>
                                                          <span class="n">humanreadable_state</span><span class="p">,</span> <span class="n">humanreadable_signal</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HighLowTransceiver.handle_reply"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.handle_reply">[документация]</a>    <span class="k">def</span> <span class="nf">handle_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reply</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Обрабатывает ответы по ПО низкого уровня</span>

<span class="sd">        Отправляет ответы на запросы измерения сопротивления изоляции в канал Redis</span>
<span class="sd">        ``axiomLowLevelCommunication:response:insulation`` в формате</span>
<span class="sd">        ``&lt;адрес выхода силового модуля&gt; &lt;измеренное значение&gt;``. Записывает измеренное значение</span>
<span class="sd">        в структуру состояния силовых модулей :attr:`power_units_state_dicts`</span>

<span class="sd">        :type reply: str</span>
<span class="sd">        :param reply: посылка типа &quot;rply&quot; от ПО низкого уровня</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Сообщение от низкого уровня: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;isol&#39;</span> <span class="ow">in</span> <span class="n">reply</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">isol_value</span><span class="p">,</span> <span class="n">cntAddr</span> <span class="o">=</span> <span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">channel_position</span> <span class="o">=</span> <span class="n">channel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">unit_addr</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="n">reply</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">):]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;isol&#39;</span><span class="p">][</span><span class="s1">&#39;isol</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]</span> <span class="o">=</span> <span class="n">isol_value</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s1">&#39;axiomLowLevelCommunication:response:insulation&#39;</span><span class="p">,</span> <span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">unit_addr</span><span class="p">,</span> <span class="n">channel_position</span><span class="p">,</span> <span class="n">isol_value</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="HighLowTransceiver.update_power_unit_state"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.update_power_unit_state">[документация]</a>    <span class="k">def</span> <span class="nf">update_power_unit_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Обрабатывает посылки от ПО силовых модулей</span>

<span class="sd">        * для посылок типа &quot;rply&quot; вызывается функция :func:`handle_reply`</span>
<span class="sd">        * для посылок типа &quot;st&quot; вызывается функция :func:`on_new_state_parcel`;</span>
<span class="sd">        * для посылок тика &quot;st&quot;, &quot;adc&quot;, &quot;ld&quot;, &quot;tmpr&quot; обновляются соответстующие поля структуры :attr:`power_units_state_dicts`;</span>
<span class="sd">        * для всех посылок вызываетс функция :func:`check_power_unit_counter`.</span>

<span class="sd">        :type unit_addr: str</span>
<span class="sd">        :param unit_addr: адрес силового модуля</span>

<span class="sd">        .. figure:: _static/update_power_unit_state.png</span>
<span class="sd">           :scale: 50%</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Компилируем регулярное выражение для парсинга посылок</span>
        <span class="n">binary_pu_regex</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pu_regex</span> <span class="o">%</span> <span class="n">unit_addr</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">power_unit_parcel_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">binary_pu_regex</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">raw_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">read_generator</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isRunning</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># Разбираем считанные данные с помощью регулярного выражения</span>
            <span class="n">byte_parcel</span> <span class="o">=</span> <span class="n">power_unit_parcel_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
            <span class="c1"># print(&#39;byte_parcel&#39;, byte_parcel)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">byte_parcel</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># декодируем посылку</span>
            <span class="n">parcel</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">byte_parcel</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span><span class="p">}</span>

            <span class="c1"># Определяем тип посылки</span>
            <span class="n">parcel_type</span> <span class="o">=</span> <span class="n">parcel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type_st&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                          <span class="n">parcel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type_adc&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                          <span class="n">parcel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type_ld&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                          <span class="n">parcel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type_tmpr&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                          <span class="n">parcel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type_rply&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># &lt;editor-fold desc=&quot;ответ на ранее отправленную команду&quot;&gt;</span>
            <span class="k">if</span> <span class="n">parcel_type</span> <span class="o">==</span> <span class="s1">&#39;rply&#39;</span><span class="p">:</span>
                <span class="n">reply</span> <span class="o">=</span> <span class="n">parcel</span><span class="p">[</span><span class="s1">&#39;reply&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_reply</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># &lt;/editor-fold&gt;</span>

            <span class="c1"># Счетчик посылки</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="n">parcel</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span>

            <span class="c1"># Проверка счетчика посылок</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_power_unit_counter</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">,</span> <span class="n">parcel_type</span><span class="p">)</span>

            <span class="c1"># В случае изменения состояния силовых выходов</span>
            <span class="k">if</span> <span class="n">parcel_type</span> <span class="o">==</span> <span class="s1">&#39;st&#39;</span><span class="p">:</span>
                <span class="c1"># print(raw_data)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_new_state_parcel</span><span class="p">(</span><span class="n">parcel</span><span class="p">)</span>

            <span class="c1"># Обновление структуры состояния модуля</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="n">parcel_type</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="n">parcel_type</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">parcel</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="HighLowTransceiver.update_input_unit_state"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.update_input_unit_state">[документация]</a>    <span class="k">def</span> <span class="nf">update_input_unit_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Обрабатывает посылки от ПО модулей ввода</span>

<span class="sd">        * для посылок типа &quot;rply&quot; вызывается функция :func:`handle_reply`</span>
<span class="sd">        * для посылок тика &quot;st&quot;, &quot;volt&quot;, &quot;cur&quot; обновляются соответстующие поля структуры :attr:`input_units_state_dicts`;</span>
<span class="sd">        * для всех посылок вызываетс функция :func:`check_input_unit_counter`.</span>

<span class="sd">        :type unit_addr: str</span>
<span class="sd">        :param unit_addr: адрес модуля ввода</span>

<span class="sd">        .. figure:: _static/update_input_unit_state.png</span>
<span class="sd">           :scale: 50%</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">binary_iu_regex</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iu_regex</span> <span class="o">%</span> <span class="n">unit_addr</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">input_unit_parcel_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">binary_iu_regex</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">raw_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">read_generator</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isRunning</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># Разбираем считанные данные с помощью регулярного выражения</span>
            <span class="n">byte_parcel</span> <span class="o">=</span> <span class="n">input_unit_parcel_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">byte_parcel</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># декодируем посылку</span>
            <span class="n">parcel</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">byte_parcel</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span><span class="p">}</span>

            <span class="c1"># Определяем тип посылки</span>
            <span class="n">parcel_type</span> <span class="o">=</span> <span class="n">parcel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type_st&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                          <span class="n">parcel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type_volt&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                          <span class="n">parcel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type_cur&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                          <span class="n">parcel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type_rply&#39;</span><span class="p">)</span>

            <span class="c1"># &lt;editor-fold desc=&quot;ответ на ранее отправленную команду&quot;&gt;</span>
            <span class="k">if</span> <span class="n">parcel_type</span> <span class="o">==</span> <span class="s1">&#39;rply&#39;</span><span class="p">:</span>
                <span class="n">reply</span> <span class="o">=</span> <span class="n">parcel</span><span class="p">[</span><span class="s1">&#39;reply&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Сообщение от низкого уровня: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># &lt;/editor-fold&gt;</span>

            <span class="c1"># Счетчик посылки</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="n">parcel</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span>

            <span class="c1"># Проверка счетчика посылок</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_input_unit_counter</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">,</span> <span class="n">parcel_type</span><span class="p">)</span>

            <span class="c1"># Обновление структуры состояния модуля</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="n">parcel_type</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="n">parcel_type</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">parcel</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

            <span class="c1"># pprint(self.input_units_state_dicts)</span>

<div class="viewcode-block" id="HighLowTransceiver.reader_target"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.reader_target">[документация]</a>    <span class="k">def</span> <span class="nf">reader_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Осуществляет прием данных от низкоуровневого ПО</span>

<span class="sd">        Для каждого силового и вводного модуля запускает в отдельном потоке функцию</span>
<span class="sd">        :func:`update_power_unit_state` или :func:`update_input_unit_state` соответственно</span>
<span class="sd">        и контролирует работу запущенных потоков</span>

<span class="sd">        .. figure:: _static/reader_target.png</span>
<span class="sd">           :scale: 50%</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Создаем потоки для обновления структуры состояния для каждого модуля</span>
        <span class="n">updaters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">unit_addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_unit_addrs</span><span class="p">:</span>
            <span class="n">updaters</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_power_unit_state</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">,))</span>
            <span class="n">updaters</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">unit_addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_unit_addrs</span><span class="p">:</span>
            <span class="n">updaters</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_input_unit_state</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">,))</span>
            <span class="n">updaters</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Контролируем, чтобы все потоки были в рабочем состоянии</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">isRunning</span><span class="p">:</span>
            <span class="c1"># self.event.wait()</span>
            <span class="c1"># self.collect_units_state()</span>
            <span class="k">for</span> <span class="n">unit_addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_unit_addrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">updaters</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                    <span class="n">updaters</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_power_unit_state</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">,))</span>
                    <span class="n">updaters</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">unit_addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_unit_addrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">updaters</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                    <span class="n">updaters</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_input_unit_state</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">,))</span>
                    <span class="n">updaters</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="HighLowTransceiver.init_power_unit"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.init_power_unit">[документация]</a>    <span class="k">def</span> <span class="nf">init_power_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Инициализирует силовой модуль</span>

<span class="sd">        Отправляет на силовой модуль команды запуска и установки порогов и</span>
<span class="sd">        проверяет их исполнение. После запуска и установки порогов</span>
<span class="sd">        включает выходы, которые были включены до перезагрузки модуля</span>

<span class="sd">        :type unit_addr: str</span>
<span class="sd">        :param unit_addr: адрес силового модуля</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        :return: True - инициализация прошла успешно, False - возникли ошибки</span>

<span class="sd">        .. figure:: _static/init_power_unit.png</span>
<span class="sd">           :scale: 50%</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># Смотрим в каком состоянии были каналы до перезагрузки</span>
        <span class="n">raw_ch1_prev_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">))</span>
        <span class="n">raw_ch2_prev_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">))</span>

        <span class="c1"># блокировщики управления в каналах модуля</span>
        <span class="n">ch1_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_locks</span><span class="p">[</span><span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)]</span>
        <span class="n">ch2_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_locks</span><span class="p">[</span><span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)]</span>

        <span class="c1"># Если удалось установить блокировку управления первым каналом -</span>
        <span class="c1"># пытаемся установить блокировку управления вторым каналом</span>
        <span class="k">if</span> <span class="n">ch1_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
            <span class="c1"># Если блокировку управления вторым каналом установить не удалось:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ch2_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
                <span class="c1"># 0. снимаем блокировку управления первым каналом</span>
                <span class="n">ch1_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="c1"># 1. Проверяем, возможно инициализация уже выполнена в другом потоке</span>
                <span class="n">check_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">check_time</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">ch1_current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span>
                    <span class="n">ch2_current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ch1_current_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ch2_current_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

                <span class="c1"># Если модуль не переходит в инициализированное состояние</span>
                <span class="c1"># 2. логируем ошибку</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Ошибка при инициализации модуля &quot;</span><span class="si">{}</span><span class="s1">&quot;:&#39;</span> \
                          <span class="s1">&#39; не удается заблокировать управление вторым каналом&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>

                <span class="c1"># 3. Возвращаем False</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Если блокировку управления первым каналом установить не удалось:</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 0. Проверяем, возможно инициализация уже выполнена в другом потоке</span>
            <span class="n">check_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">check_time</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">ch1_current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span>
                <span class="n">ch2_current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ch1_current_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ch2_current_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="c1"># 1. Если модуль не переходит в инициализированное состояние - логируем ошибку, возвращаем False</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Ошибка при инициализации модуля &quot;</span><span class="si">{}</span><span class="s1">&quot;:&#39;</span> \
                      <span class="s1">&#39; не удается заблокировать управление первым каналом&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># После блокировки управления в обоих каналах модуля, смотрим состояние каналов</span>
        <span class="n">ch1_current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span>
        <span class="n">ch2_current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span>

        <span class="c1"># Если хотя бы один из каналов в состоянии 1 (idle) - вызываем функцию запуска модуля</span>
        <span class="k">if</span> <span class="n">ch1_current_state</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="ow">or</span> <span class="n">ch2_current_state</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_power_unit</span><span class="p">(</span><span class="n">unit_addr</span><span class="o">=</span><span class="n">unit_addr</span><span class="p">):</span>
                <span class="n">ch1_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ch2_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Если функция запуска завершилась успешно - снова смотрим состояние каналов</span>
        <span class="n">ch1_current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span>
        <span class="n">ch2_current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span>

        <span class="c1"># Если хотя бы один из каналов в состоянии 3 (nuse) - вызываем функцию конфигурации модуля</span>
        <span class="k">if</span> <span class="n">ch1_current_state</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span> <span class="ow">or</span> <span class="n">ch2_current_state</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_power_unit</span><span class="p">(</span><span class="n">unit_addr</span><span class="o">=</span><span class="n">unit_addr</span><span class="p">):</span>
                <span class="n">ch1_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ch2_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Если функция конфигурации завершилась успешно:</span>
        <span class="c1"># 1.снимаем блокировку управления каналами</span>
        <span class="n">ch1_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ch2_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># 2. восстанавливаем состояние выходов сохраненное в БД (если это возможно)</span>
        <span class="k">for</span> <span class="n">ch_position</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">):</span>
            <span class="n">raw_prev_ch_state</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;raw_ch</span><span class="si">{}</span><span class="s1">_prev_state&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch_position</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prev_ch_state</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">raw_prev_ch_state</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prev_ch_state</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;5&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_ch_state</span><span class="p">(</span><span class="n">channel_addr</span><span class="o">=</span><span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">,</span> <span class="n">ch_position</span><span class="p">),</span>
                                      <span class="n">new_state_dict</span><span class="o">=</span><span class="n">prev_ch_state</span><span class="p">)</span>
            <span class="c1"># Если в БД было сохранено некорректное значение (или не записано никакое) - ничего не делаем</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># 3. возвращаем True</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="HighLowTransceiver.run_power_unit"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.run_power_unit">[документация]</a>    <span class="k">def</span> <span class="nf">run_power_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Запускает ПО силового модуля</span>

<span class="sd">        Отправляет на модуль команду запуска ``run start &lt;unit_addr&gt;``.</span>
<span class="sd">        Контролирует исполнение команды. Команда считается выполненной</span>
<span class="sd">        успешно, если ни один из каналов не остался в состоянии &#39;0&#39; (idle)</span>

<span class="sd">        :type unit_addr: str</span>
<span class="sd">        :param unit_addr: адрес силового модуля</span>
<span class="sd">        :type retries: int</span>
<span class="sd">        :param retries: количество возможных повторых попыток</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        :return: True - успешное исполнение команды), False - неуспешное</span>

<span class="sd">        .. figure:: _static/run_power_unit.png</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Команда запуска модуля:</span>
        <span class="n">run_cmd</span> <span class="o">=</span> <span class="s1">&#39;run start </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Фиксируем время отправки</span>
            <span class="n">send_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Если команда записана в последовательный порт успешно:</span>
            <span class="c1"># self.event.clear()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_cmd</span><span class="p">):</span>
                <span class="c1"># self.event.set()</span>
                <span class="c1"># Пока не истек таймаут, смотрим на состояние выходов</span>
                <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">send_time</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">ch1_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span>
                    <span class="n">ch2_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span>

                    <span class="c1"># Если состояние хотя бы одного остается &#39;0&#39; - ждем дальше</span>
                    <span class="k">if</span> <span class="n">ch1_state</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ch2_state</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">):</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="c1"># Если состояние обоих выходов не &#39;0&#39; - запуск модуля завершен. Логируем успех, возвращаем True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ch1_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span>
                        <span class="n">ch2_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span>

                        <span class="n">ch1_humanreadable_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">ch1_state</span><span class="p">]</span>
                        <span class="n">ch2_humanreadable_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">ch2_state</span><span class="p">]</span>

                        <span class="n">channel1_addr</span> <span class="o">=</span> <span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>
                        <span class="n">channel2_addr</span> <span class="o">=</span> <span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>

                        <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Запуск модуля &quot;</span><span class="si">{}</span><span class="s1">&quot; выполнен.&#39;</span> \
                                  <span class="s1">&#39; Текущее состояние выходов: &quot;</span><span class="si">{}</span><span class="s1">&quot; - &quot;</span><span class="si">{}</span><span class="s1">&quot;, &quot;</span><span class="si">{}</span><span class="s1">&quot; - &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">unit_addr</span><span class="p">,</span> <span class="n">channel1_addr</span><span class="p">,</span> <span class="n">ch1_humanreadable_state</span><span class="p">,</span> <span class="n">channel2_addr</span><span class="p">,</span> <span class="n">ch2_humanreadable_state</span><span class="p">)</span>

                        <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

                        <span class="k">return</span> <span class="kc">True</span>
                <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="c1"># Если при записи команды возникли ошибки - пробуем еще</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># self.event.set()</span>
                <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># Если дошли до сюда, значит, запуск выполнить не удалось. Логируем ошибку, возвращаем False</span>
        <span class="n">ch1_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span>
        <span class="n">ch2_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span>

        <span class="n">ch1_humanreadable_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">ch1_state</span><span class="p">]</span>
        <span class="n">ch2_humanreadable_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">ch2_state</span><span class="p">]</span>

        <span class="n">channel1_addr</span> <span class="o">=</span> <span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>
        <span class="n">channel2_addr</span> <span class="o">=</span> <span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Ошибка при выполнении запуска модуля &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span> \
                  <span class="s1">&#39; Текущее состояние выходов: &quot;</span><span class="si">{}</span><span class="s1">&quot; - &quot;</span><span class="si">{}</span><span class="s1">&quot;, &quot;</span><span class="si">{}</span><span class="s1">&quot; - &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">unit_addr</span><span class="p">,</span> <span class="n">channel1_addr</span><span class="p">,</span> <span class="n">ch1_humanreadable_state</span><span class="p">,</span> <span class="n">channel2_addr</span><span class="p">,</span> <span class="n">ch2_humanreadable_state</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="HighLowTransceiver.configure_power_unit"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.configure_power_unit">[документация]</a>    <span class="k">def</span> <span class="nf">configure_power_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Конфигурирует ПО силового модуля:</span>

<span class="sd">        Отправляет на силовой модуль команды конфигурации:</span>

<span class="sd">        * установка порогов по току потребления : ``adc hgrp &lt;Imax1&gt; &lt;Imax2&gt; &lt;crc8-1&gt; &lt;crc8-2&gt; &lt;unit_addr&gt;``;</span>
<span class="sd">        * установка порогов по току утечки: ``adc hlgrp &lt;Imax1&gt; &lt;Imax2&gt; &lt;crc8-1&gt; &lt;crc8-2&gt; &lt;unit_addr&gt;``.</span>

<span class="sd">        Контролирует исполнение команд. Команды считается выполненными успешно,</span>
<span class="sd">        если ни один из каналов не остался в состоянии &#39;3&#39; (nuse)</span>

<span class="sd">        :type unit_addr: str</span>
<span class="sd">        :param unit_addr: адрес силового модуля</span>
<span class="sd">        :type retries: int</span>
<span class="sd">        :param retries: количество возможных повторых попыток</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        :return: True - успешное исполнение команды), False - неуспешное</span>

<span class="sd">        .. figure:: _static/configure_power_unit.png</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Команда установки порогов по току потребления:</span>
        <span class="n">max_consumption_current_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;power units&#39;</span><span class="p">][</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;max consumption current&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_consumption_current_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;power units&#39;</span><span class="p">][</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;max consumption current&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">Iconsumption1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">33</span> <span class="o">*</span> <span class="n">max_consumption_current_1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">Iconsumption2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">33</span> <span class="o">*</span> <span class="n">max_consumption_current_2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span>

        <span class="n">buff1_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_to_bytes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">Iconsumption1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">buff2_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_to_bytes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">Iconsumption2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">crc1_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crc8</span><span class="p">(</span><span class="n">buff1_consumption</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span>
        <span class="n">crc2_consumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crc8</span><span class="p">(</span><span class="n">buff2_consumption</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span>

        <span class="n">consumption_current_cmd</span> <span class="o">=</span> <span class="s1">&#39;adc hgrp </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">Iconsumption1</span><span class="p">,</span> <span class="n">Iconsumption2</span><span class="p">,</span> <span class="n">crc1_consumption</span><span class="p">,</span> <span class="n">crc2_consumption</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">)</span>
        <span class="c1"># consumption_current_cmd = &#39;adc h 255 all 1 {}&#39;.format(unit_addr)</span>
        <span class="c1"># print(consumption_current_cmd)</span>

        <span class="c1"># Команда установки порогов по току утечки:</span>
        <span class="n">max_leak_current_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;power units&#39;</span><span class="p">][</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;max leak current&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_leak_current_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;power units&#39;</span><span class="p">][</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;max leak current&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">Ileak1</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="mi">65534</span> <span class="o">*</span> <span class="mi">33</span> <span class="o">*</span> <span class="n">max_leak_current_1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1500</span><span class="p">)</span>
        <span class="n">Ileak2</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="mi">65534</span> <span class="o">*</span> <span class="mi">33</span> <span class="o">*</span> <span class="n">max_leak_current_2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1500</span><span class="p">)</span>

        <span class="n">buff1_leak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_to_bytes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">Ileak1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">buff2_leak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_to_bytes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">Ileak2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">crc1_leak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crc8</span><span class="p">(</span><span class="n">buff1_leak</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span>
        <span class="n">crc2_leak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crc8</span><span class="p">(</span><span class="n">buff2_leak</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span>

        <span class="n">leak_current_cmd</span> <span class="o">=</span> <span class="s1">&#39;adc hlgrp </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Ileak1</span><span class="p">,</span> <span class="n">Ileak2</span><span class="p">,</span> <span class="n">crc1_leak</span><span class="p">,</span> <span class="n">crc2_leak</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">leak_current_cmd</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Фиксируем время отправки</span>
            <span class="n">send_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># self.event.clear()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="c1"># Если команда записана в последовательный порт успешно:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">consumption_current_cmd</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">leak_current_cmd</span><span class="p">):</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="c1"># Пока не истек таймаут, смотрим на состояние выходов</span>
                    <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">send_time</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">ch1_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span>
                        <span class="n">ch2_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span>

                        <span class="c1"># Если состояние хотя бы одного остается &#39;3&#39; - ждем дальше</span>
                        <span class="k">if</span> <span class="n">ch1_state</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span> <span class="ow">or</span> <span class="n">ch2_state</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="c1"># Если состояние обоих выходов не &#39;3&#39; - запуск модуля завершен. Логируем успех, возвращаем True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ch1_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span>
                            <span class="n">ch2_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span>

                            <span class="n">ch1_humanreadable_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">ch1_state</span><span class="p">]</span>
                            <span class="n">ch2_humanreadable_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">ch2_state</span><span class="p">]</span>

                            <span class="n">channel1_addr</span> <span class="o">=</span> <span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>
                            <span class="n">channel2_addr</span> <span class="o">=</span> <span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>

                            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Конфигурация модуля &quot;</span><span class="si">{}</span><span class="s1">&quot; выполнена.&#39;</span> \
                                      <span class="s1">&#39; Текущее состояние выходов: &quot;</span><span class="si">{}</span><span class="s1">&quot; - &quot;</span><span class="si">{}</span><span class="s1">&quot;, &quot;</span><span class="si">{}</span><span class="s1">&quot; - &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">unit_addr</span><span class="p">,</span> <span class="n">channel1_addr</span><span class="p">,</span> <span class="n">ch1_humanreadable_state</span><span class="p">,</span>
                                <span class="n">channel2_addr</span><span class="p">,</span> <span class="n">ch2_humanreadable_state</span><span class="p">)</span>

                            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

                            <span class="k">return</span> <span class="kc">True</span>
                    <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="c1"># Если при записи команды возникли ошибки - пробуем еще</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># Если дошли до сюда, значит, конфигурацию выполнить не удалось. Логируем ошибку, возвращаем False</span>
        <span class="n">ch1_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span>
        <span class="n">ch2_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span>

        <span class="n">ch1_humanreadable_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">ch1_state</span><span class="p">]</span>
        <span class="n">ch2_humanreadable_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">ch2_state</span><span class="p">]</span>

        <span class="n">channel1_addr</span> <span class="o">=</span> <span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>
        <span class="n">channel2_addr</span> <span class="o">=</span> <span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Ошибка1 при выполнении конфигурации модуля &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span> \
                  <span class="s1">&#39; Текущее состояние выходов: &quot;</span><span class="si">{}</span><span class="s1">&quot; - &quot;</span><span class="si">{}</span><span class="s1">&quot;, &quot;</span><span class="si">{}</span><span class="s1">&quot; - &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">unit_addr</span><span class="p">,</span> <span class="n">channel1_addr</span><span class="p">,</span> <span class="n">ch1_humanreadable_state</span><span class="p">,</span>
            <span class="n">channel2_addr</span><span class="p">,</span> <span class="n">ch2_humanreadable_state</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="HighLowTransceiver.before_return_from_set_ch_state"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.before_return_from_set_ch_state">[документация]</a>    <span class="k">def</span> <span class="nf">before_return_from_set_ch_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">,</span> <span class="n">channel_addr</span><span class="p">,</span> <span class="n">current_state</span><span class="p">,</span> <span class="n">redis_error_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Вызывается перед выходом из фунции :func:`set_ch_state`</span>

<span class="sd">        Выполняет следущие действия:</span>

<span class="sd">        #. Публикует на брокер текущее состояние силового выхода;</span>
<span class="sd">        #. Записывает в лог результат выполнения команды;</span>
<span class="sd">        #. Публикует на брокер сообщение об ошибке, если она есть;</span>

<span class="sd">        :type log_msg: str</span>
<span class="sd">        :param log_msg: сообщение для записи в лог</span>
<span class="sd">        :type channel_addr: str</span>
<span class="sd">        :param channel_addr: адрес канала силового модуля</span>
<span class="sd">        :type current_state: str</span>
<span class="sd">        :param current_state: текущее состояние канала силового модуля (&#39;0&#39;...&#39;7&#39;)</span>
<span class="sd">        :type redis_error_msg: str</span>
<span class="sd">        :param redis_error_msg: сообщение об ошибке для публикации на брокер (по умолчанию None)</span>

<span class="sd">        .. figure:: _static/before_return_from_set_ch_state.png</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;ERROR&#39;</span> <span class="k">if</span> <span class="n">redis_error_msg</span> <span class="k">else</span> <span class="s1">&#39;INFO&#39;</span>

        <span class="n">state_to_publish</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;addr&#39;</span><span class="p">:</span> <span class="n">channel_addr</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">current_state</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;axiomLowLevelCommunication:info:state&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">state_to_publish</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">log_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">redis_error_msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;axiomLowLevelCommunication:info:error&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">redis_error_msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="HighLowTransceiver.set_ch_state"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.set_ch_state">[документация]</a>    <span class="k">def</span> <span class="nf">set_ch_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_addr</span><span class="p">,</span> <span class="n">new_state_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Выполняет команду установки нового состояния выхода силового модуля</span>

<span class="sd">        Отправляет на низкий уровень команду ``ch 1|2 on|off &lt;unit_addr&gt;``.</span>
<span class="sd">        Контролирует исполнение команды. Перед выходом вызывает метод :meth:`before_return_from_set_ch_state`.</span>

<span class="sd">        :type channel_addr: str</span>
<span class="sd">        :param channel_addr: адрес канала силового модуля</span>
<span class="sd">        :type new_state_dict: dict</span>
<span class="sd">        :param new_state_dict: состояние канала силового модуля, которое нужно установить. Формат: ``{&#39;status&#39;: &#39;4&#39;|&#39;5&#39;}``</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        :return: True - команда выполнена, False - возникли ошибки</span>

<span class="sd">        .. figure:: _static/set_ch_state.png</span>
<span class="sd">           :scale: 50%</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Валидация команды</span>
        <span class="n">invalid_cmd_log_msg</span> <span class="o">=</span> <span class="s1">&#39;Получены некорректные данные для установки нового состояния силового выхода:&#39;</span> \
                              <span class="s1">&#39; адрес канала: </span><span class="si">{}</span><span class="s1">, новое состояние: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_addr</span><span class="p">,</span> <span class="n">new_state_dict</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">unit_addr</span> <span class="o">=</span> <span class="n">channel_addr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">channel_position</span> <span class="o">=</span> <span class="n">channel_addr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">invalid_cmd_log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="n">new_state_dict</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">invalid_cmd_log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">unit_addr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_unit_addrs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">invalid_cmd_log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">channel_position</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">invalid_cmd_log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">new_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">invalid_cmd_log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Если команда прошла валидацию, пишем в лог сообщение, что получена команда</span>
        <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Получена команда на установку состояния &quot;</span><span class="si">{}</span><span class="s1">&quot; на выходе &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">new_state</span><span class="p">],</span> <span class="n">channel_addr</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

        <span class="c1">###############################################</span>
        <span class="c1"># проверяем можно ли управлять данным каналом #</span>
        <span class="c1">###############################################</span>

        <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]</span>

        <span class="c1"># Проверяем проинициализирован ли модуль</span>
        <span class="k">if</span> <span class="n">current_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">]:</span>
            <span class="c1"># Если не проинициализирован - пишем об этом в лог и вызываем функцию инициализации</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Силовой выход </span><span class="si">{}</span><span class="s1"> находится в состоянии </span><span class="si">{}</span><span class="s1">. Требуется инициализация модуля&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">channel_addr</span><span class="p">,</span> <span class="n">current_state</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;WARNING&#39;</span><span class="p">)</span>

            <span class="c1"># Если инициализация не удалась - снимаем блокировку управления,</span>
            <span class="c1"># вызываем before_return_from_set_ch_state и выходим</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_power_unit</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">):</span>
                <span class="n">current_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;signal</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]</span>

                <span class="n">humanreadable_current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">current_state</span><span class="p">]</span>
                <span class="n">humanreadable_new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">new_state</span><span class="p">]</span>
                <span class="n">humanreadable_current_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_signals</span><span class="p">[</span><span class="n">current_signal</span><span class="p">]</span>

                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Невозможно установить в канале &quot;</span><span class="si">{}</span><span class="s1">&quot; состояние &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span> \
                          <span class="s1">&#39; Канал находится в состоянии: &quot;</span><span class="si">{}</span><span class="s1">&quot;, сигнал перехода: &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">channel_addr</span><span class="p">,</span> <span class="n">humanreadable_new_state</span><span class="p">,</span> <span class="n">humanreadable_current_state</span><span class="p">,</span>
                    <span class="n">humanreadable_current_signal</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">before_return_from_set_ch_state</span><span class="p">(</span><span class="n">channel_addr</span><span class="o">=</span><span class="n">channel_addr</span><span class="p">,</span>
                                                     <span class="n">current_state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
                                                     <span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span>
                                                     <span class="n">redis_error_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">)</span>

                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Заново записываем состояние в переменную, потому что оно могло измениться</span>
        <span class="c1"># после вызова init_power_unit</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]</span>

        <span class="c1"># Проверяем, что силовой выход не находится в состоянии fault, poff или lock</span>
        <span class="c1"># Если в одном из этих состояний, то выходим:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">]:</span>
            <span class="n">current_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;signal</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]</span>
            <span class="n">humanreadable_current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">current_state</span><span class="p">]</span>
            <span class="n">humanreadable_new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">new_state</span><span class="p">]</span>
            <span class="n">humanreadable_current_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_signals</span><span class="p">[</span><span class="n">current_signal</span><span class="p">]</span>

            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Невозможно установить в канале &quot;</span><span class="si">{}</span><span class="s1">&quot; состояние &quot;</span><span class="si">{}</span><span class="s1">&quot;. Канал находится в состоянии: &quot;</span><span class="si">{}</span><span class="s1">&quot;, &#39;</span> \
                      <span class="s1">&#39;сигнал перехода: &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_addr</span><span class="p">,</span> <span class="n">humanreadable_new_state</span><span class="p">,</span> <span class="n">humanreadable_current_state</span><span class="p">,</span>
                                                     <span class="n">humanreadable_current_signal</span><span class="p">,</span> <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">before_return_from_set_ch_state</span><span class="p">(</span><span class="n">channel_addr</span><span class="o">=</span><span class="n">channel_addr</span><span class="p">,</span>
                                                 <span class="n">current_state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
                                                 <span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span>
                                                 <span class="n">redis_error_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Если состояние, которое требуется установить и так уже установлено - выходим</span>
        <span class="k">if</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">new_state</span><span class="p">:</span>
            <span class="n">humanreadable_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">current_state</span><span class="p">]</span>

            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Выполнение команды не требуется. Выход &quot;</span><span class="si">{}</span><span class="s1">&quot; уже находится в состоянии &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">channel_addr</span><span class="p">,</span> <span class="n">humanreadable_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">before_return_from_set_ch_state</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">channel_addr</span><span class="o">=</span><span class="n">channel_addr</span><span class="p">,</span>
                                                 <span class="n">current_state</span><span class="o">=</span><span class="n">current_state</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1">###############################################</span>
        <span class="c1">#               Отправляем команду            #</span>
        <span class="c1">###############################################</span>

        <span class="c1"># Если удалось захватить управление каналом</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_locks</span><span class="p">[</span><span class="n">channel_addr</span><span class="p">]</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
            <span class="c1"># команда для отправки + команда для светодиода</span>
            <span class="k">if</span> <span class="n">new_state</span> <span class="o">==</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span>
                <span class="n">ch_cmd</span> <span class="o">=</span> <span class="s1">&#39;ch </span><span class="si">{}</span><span class="s1"> off </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">)</span>
                <span class="n">led_cmd</span> <span class="o">=</span> <span class="s1">&#39;led inst </span><span class="si">{}</span><span class="s1"> off </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">new_state</span> <span class="o">==</span> <span class="s1">&#39;5&#39;</span><span class="p">:</span>
                <span class="n">ch_cmd</span> <span class="o">=</span> <span class="s1">&#39;ch </span><span class="si">{}</span><span class="s1"> on </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">)</span>
                <span class="n">led_cmd</span> <span class="o">=</span> <span class="s1">&#39;led inst </span><span class="si">{}</span><span class="s1"> on </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">sending_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Если команда записана в последовательный порт успешно -</span>
            <span class="c1"># начинаем мониторить структуру состояния пока не истечет таймаут</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ch_cmd</span><span class="p">):</span>
                <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">sending_time</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]</span>

                    <span class="c1"># 1. Если текущее состояние стало таким, каким его хотели сделать -</span>
                    <span class="c1"># включаем/выключаем светодиод, снимаем блокировку и выходим</span>
                    <span class="k">if</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">new_state</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">led_cmd</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ch_locks</span><span class="p">[</span><span class="n">channel_addr</span><span class="p">]</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="k">return</span> <span class="kc">True</span>

                    <span class="c1"># 2. Канал перешел в нерабочее состояние</span>
                    <span class="k">elif</span> <span class="n">current_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">]:</span>
                        <span class="c1"># Выключаем светодиод</span>
                        <span class="n">led_cmd</span> <span class="o">=</span> <span class="s1">&#39;led inst </span><span class="si">{}</span><span class="s1"> off </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">led_cmd</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">ch_locks</span><span class="p">[</span><span class="n">channel_addr</span><span class="p">]</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                        <span class="n">current_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span>
                            <span class="s1">&#39;signal</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]</span>

                        <span class="n">humanreadable_new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">new_state</span><span class="p">]</span>
                        <span class="n">humanreadable_result_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">current_state</span><span class="p">]</span>
                        <span class="n">humanreadable_result_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_signals</span><span class="p">[</span><span class="n">current_signal</span><span class="p">]</span>

                        <span class="n">redis_msg</span> <span class="o">=</span> <span class="s1">&#39;Ошибка при установке состояния &quot;</span><span class="si">{}</span><span class="s1">&quot; на выходе &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span> \
                                    <span class="s1">&#39; Текущее состояние: &quot;</span><span class="si">{}</span><span class="s1">&quot;, сигнал перехода в состояние: &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">humanreadable_new_state</span><span class="p">,</span> <span class="n">channel_addr</span><span class="p">,</span> <span class="n">humanreadable_result_state</span><span class="p">,</span>
                            <span class="n">humanreadable_result_signal</span><span class="p">)</span>
                        <span class="n">log_msg</span> <span class="o">=</span> <span class="n">redis_msg</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">before_return_from_set_ch_state</span><span class="p">(</span><span class="n">channel_addr</span><span class="o">=</span><span class="n">channel_addr</span><span class="p">,</span>
                                                             <span class="n">current_state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
                                                             <span class="n">redis_error_msg</span><span class="o">=</span><span class="n">redis_msg</span><span class="p">,</span>
                                                             <span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>

                <span class="c1"># Если до истечения таймаута состояние не изменилось</span>

                <span class="n">current_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span>
                    <span class="s1">&#39;signal</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ch_locks</span><span class="p">[</span><span class="n">channel_addr</span><span class="p">]</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                <span class="n">humanreadable_new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">new_state</span><span class="p">]</span>
                <span class="n">humanreadable_result_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">current_state</span><span class="p">]</span>
                <span class="n">humanreadable_result_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_signals</span><span class="p">[</span><span class="n">current_signal</span><span class="p">]</span>

                <span class="n">redis_msg</span> <span class="o">=</span> <span class="s1">&#39;Ошибка при установке состояния &quot;</span><span class="si">{}</span><span class="s1">&quot; на выходе &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span> \
                            <span class="s1">&#39; Текущее состояние: &quot;</span><span class="si">{}</span><span class="s1">&quot;, сигнал перехода в состояние: &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">humanreadable_new_state</span><span class="p">,</span> <span class="n">channel_addr</span><span class="p">,</span> <span class="n">humanreadable_result_state</span><span class="p">,</span>
                    <span class="n">humanreadable_result_signal</span><span class="p">)</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="n">redis_msg</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">before_return_from_set_ch_state</span><span class="p">(</span><span class="n">channel_addr</span><span class="o">=</span><span class="n">channel_addr</span><span class="p">,</span>
                                                     <span class="n">current_state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
                                                     <span class="n">redis_error_msg</span><span class="o">=</span><span class="n">redis_msg</span><span class="p">,</span>
                                                     <span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">)</span>

                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># Если не удалось записать команду в последовательный порт -</span>
            <span class="c1"># вызываем before_set_ch_state, снимаем блокировку управления и выходим</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># self.event.set()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ch_locks</span><span class="p">[</span><span class="n">channel_addr</span><span class="p">]</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                <span class="n">humanreadable_new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">new_state</span><span class="p">]</span>

                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Произошла ошибка записи в последовательный порт&#39;</span> \
                          <span class="s1">&#39; при установке состояния &quot;</span><span class="si">{}</span><span class="s1">&quot; на выходе &quot;</span><span class="si">{}</span><span class="s1">&quot;. Команда не выполнена.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">humanreadable_new_state</span><span class="p">,</span> <span class="n">channel_addr</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">before_return_from_set_ch_state</span><span class="p">(</span><span class="n">channel_addr</span><span class="o">=</span><span class="n">channel_addr</span><span class="p">,</span>
                                                     <span class="n">current_state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
                                                     <span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span>
                                                     <span class="n">redis_error_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">)</span>

                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Если до истечения таймаута блокировка на управление каналом не снимается - выходим</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">humanreadable_new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">humanreadable_states</span><span class="p">[</span><span class="n">new_state</span><span class="p">]</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Невозможно установить состояние &quot;</span><span class="si">{}</span><span class="s1">&quot; на выходе &quot;</span><span class="si">{}</span><span class="s1">&quot;:&#39;</span> \
                      <span class="s1">&#39; управление заблокировано другим потоком&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">humanreadable_new_state</span><span class="p">,</span> <span class="n">channel_addr</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">before_return_from_set_ch_state</span><span class="p">(</span><span class="n">channel_addr</span><span class="o">=</span><span class="n">channel_addr</span><span class="p">,</span>
                                                 <span class="n">current_state</span><span class="o">=</span><span class="n">current_state</span><span class="p">,</span>
                                                 <span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span>
                                                 <span class="n">redis_error_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="HighLowTransceiver.measure_insulation_resistance"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.measure_insulation_resistance">[документация]</a>    <span class="k">def</span> <span class="nf">measure_insulation_resistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_addr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Выполняет команду измерения сопротивления изоляции канала силового модуля</span>

<span class="sd">        Переводит силовой модуль в состояния &quot;обслуживание&quot;. Отправляет на низкий уровень</span>
<span class="sd">        команду сброса: ``rst &lt;unit_addr&gt;``. Отравляет на низкий уровень команду</span>
<span class="sd">        на измерение сопротивления изоляции: ``resist start 1|2 &lt;unit_addr&gt;``.</span>
<span class="sd">        Контролирует выполнение команды</span>

<span class="sd">        :type channel_addr: str</span>
<span class="sd">        :param channel_addr: адрес канала силового модуля</span>

<span class="sd">        .. figure:: _static/measure_insulation_resistance.png</span>
<span class="sd">           :scale: 50%</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">,</span> <span class="n">channel_position</span> <span class="o">=</span> <span class="n">channel_addr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

        <span class="c1"># Переводим модуль в режим обслуживания</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_units_maintenance</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># затираем предыдущее измеренное значение</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;isol&#39;</span><span class="p">][</span><span class="s1">&#39;isol</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># self.power_units_state_dicts[unit_addr][&#39;isol&#39;][&#39;isol2&#39;] = None</span>

        <span class="c1"># блокировщики управления в каналах модуля</span>
        <span class="n">ch_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_locks</span><span class="p">[</span><span class="s1">&#39;ch:</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">,</span> <span class="n">channel_position</span><span class="p">)]</span>
        <span class="c1"># ch2_lock = self.ch_locks[&#39;ch:{}:2&#39;.format(channel_position)]</span>

        <span class="c1"># Сбрасываем модуль</span>
        <span class="n">rst_timeout</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">check_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rst </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)):</span>
            <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">check_time</span> <span class="o">&lt;</span> <span class="n">rst_timeout</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="ow">and</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state1&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span> <span class="ow">or</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;st&#39;</span><span class="p">][</span><span class="s1">&#39;state2&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Ошибка при измерении сопротивления изоляции силового модуля </span><span class="si">{}</span><span class="s1">:&#39;</span> \
                          <span class="s1">&#39; не удается осуществить сброс модуля&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">power_units_maintenance</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Не удалось выполнить измерение сопротивления изоляции силового модуля </span><span class="si">{}</span><span class="s1">&#39;</span> \
                      <span class="s1">&#39; из-за ошибки записи  в последовательный порт команды сброса&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_addr</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_units_maintenance</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>

        <span class="c1"># Блокируем управление каналом</span>
        <span class="k">if</span> <span class="n">ch_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
            <span class="c1"># Отправляем команду</span>
            <span class="n">isol_cmd</span> <span class="o">=</span> <span class="s1">&#39;resist start </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">)</span>
            <span class="n">isol_timeout</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">check_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Отправляем команду&#39;</span><span class="p">,</span> <span class="n">isol_cmd</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">isol_cmd</span><span class="p">):</span>
                <span class="c1"># Ждем результата выполнения команды</span>
                <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">check_time</span> <span class="o">&lt;</span> <span class="n">isol_timeout</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;isol&#39;</span><span class="p">][</span><span class="s1">&#39;isol</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]:</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">ch_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">][</span><span class="s1">&#39;isol&#39;</span><span class="p">][</span><span class="s1">&#39;isol</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">)]:</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Не удалось выполнить измерение сопротивления изоляции в </span><span class="si">{}</span><span class="s1"> канале силового модуля </span><span class="si">{}</span><span class="s1">&#39;</span> \
                              <span class="s1">&#39; нет ответа от ПО низкого уровня&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
            <span class="c1"># Если не удалось отправить команду</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ch_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Не удалось выполнить измерение сопротивления изоляции в </span><span class="si">{}</span><span class="s1"> канале силового модуля </span><span class="si">{}</span><span class="s1">&#39;</span> \
                          <span class="s1">&#39; из-за ошибки записи команды в последовательный порт&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
        <span class="c1"># Если не удалось заблокировать управление каналом</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Не удалось выполнить измерение сопротивления изоляции в </span><span class="si">{}</span><span class="s1"> канале силового модуля </span><span class="si">{}</span><span class="s1">:&#39;</span> \
                      <span class="s1">&#39; управление каналом заблокировано в другом потоке&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel_position</span><span class="p">,</span> <span class="n">unit_addr</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">power_units_maintenance</span><span class="p">[</span><span class="n">unit_addr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="HighLowTransceiver.writer_target"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.writer_target">[документация]</a>    <span class="k">def</span> <span class="nf">writer_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Обрабатывает команды от функционального модуля &quot;Логика&quot;</span>

<span class="sd">        При получении команды вызывает соответствующий метод для ее обработки.</span>
<span class="sd">        Поддерживаемые команды:</span>

<span class="sd">        #. Установка нового состояния выхода силового модуля:</span>
<span class="sd">            * канал Redis: ``axiomLogic:cmd:state``;</span>
<span class="sd">            * формат команды: ``{&#39;addr&#39;: &lt;channel_addr&gt;, &#39;state&#39;: {&#39;status&#39;: &#39;4&#39;|&#39;5&#39;}}``;</span>
<span class="sd">            * метод для обработки: :meth:`set_ch_state`.</span>
<span class="sd">        #. Измерение сопротивления изоляции канала силового модуля:</span>
<span class="sd">            * канал Redis: ``axiomLogic:request:insulation``;</span>
<span class="sd">            * формат команды: ``&lt;channel_addr&gt;``;</span>
<span class="sd">            * метод для обработки: :meth:`measure_insulation_resistance`.</span>

<span class="sd">        .. figure:: _static/writer_target.png</span>
<span class="sd">           :scale: 50%</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Подписываемся на команды изменения состояния от модуля &quot;Логика&quot;</span>
        <span class="n">subscriber_state_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">pubsub</span><span class="p">(</span><span class="n">ignore_subscribe_messages</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subscriber_state_cmd</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;axiomLogic:cmd:state&#39;</span><span class="p">)</span>

        <span class="c1"># Подписываемся на команды измерения сопротивления изоляции</span>
        <span class="n">subscriber_isol_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">pubsub</span><span class="p">(</span><span class="n">ignore_subscribe_messages</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subscriber_isol_cmd</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;axiomLogic:request:insulation&#39;</span><span class="p">)</span>

        <span class="n">ch_template</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^ch:(m[1-9]):([1-2])$&#39;</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">isRunning</span><span class="p">:</span>
            <span class="c1"># &lt;editor-fold desc=&quot;Обработка команд на изменение состояния выходов&quot;&gt;</span>
            <span class="n">message_state</span> <span class="o">=</span> <span class="n">subscriber_state_cmd</span><span class="o">.</span><span class="n">get_message</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">message_state</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cmd_str</span> <span class="o">=</span> <span class="n">message_state</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;redis KeyError&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cmd_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;redis dict &quot;</span><span class="si">{}</span><span class="s1">&quot; &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">channel_addr</span> <span class="o">=</span> <span class="n">cmd_dict</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span>
                    <span class="n">new_state_dict</span> <span class="o">=</span> <span class="n">cmd_dict</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">UnboundLocalError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;redis channel_addr &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ch_template</span><span class="p">,</span> <span class="n">channel_addr</span><span class="p">):</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;redis rcv run thread&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

                    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">set_ch_state</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;channel_addr&#39;</span><span class="p">:</span> <span class="n">channel_addr</span><span class="p">,</span> <span class="s1">&#39;new_state_dict&#39;</span><span class="p">:</span> <span class="n">new_state_dict</span><span class="p">})</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;redis not match&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>

            <span class="c1"># &lt;/editor-fold&gt;</span>

            <span class="c1"># &lt;editor-fold desc=&quot;Обработка команд на измерение сопротивления изоляции&quot;&gt;</span>
            <span class="n">message_isol</span> <span class="o">=</span> <span class="n">subscriber_isol_cmd</span><span class="o">.</span><span class="n">get_message</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">message_isol</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Получена команда на измерение сопротивления изоляции&#39;</span><span class="p">)</span>
                <span class="n">channel_addr</span> <span class="o">=</span> <span class="n">message_isol</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">measure_insulation_resistance</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">channel_addr</span><span class="p">,))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span></div>
            <span class="c1"># &lt;/editor-fold&gt;</span>

<div class="viewcode-block" id="HighLowTransceiver.sigterm_handler"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.sigterm_handler">[документация]</a>    <span class="k">def</span> <span class="nf">sigterm_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Корректно останавливает программу при получении сигнала SIGTERM, SIGINT</span>

<span class="sd">        :param signum: signal number (не используется)</span>
<span class="sd">        :param frame:  current stack frame (не используется)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Остановка программы&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="n">log_msg</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isRunning</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="HighLowTransceiver.publish_current_characteristics"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.publish_current_characteristics">[документация]</a>    <span class="k">def</span> <span class="nf">publish_current_characteristics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Публикует на брокер текущие значения энергетических характеристик аппаратных модулей</span>

<span class="sd">        Запускается как задача планировщика :attr:`scheduler`. Выполняется каждые 10 секунд. Отправляет</span>
<span class="sd">        следующие характеристики:</span>

<span class="sd">        * Напряжение электросети на модулях ввода;</span>
<span class="sd">        * Частота электросети на модулях ввода;</span>
<span class="sd">        * Активная потребляемая мощность в каналах силовых модулей;</span>
<span class="sd">        * Реактивная потребляемая мощность в каналах силовых модулей;</span>
<span class="sd">        * Ток, потребляемый в каналах силовых модулей;</span>
<span class="sd">        * Температура каналов силовых модулей.</span>

<span class="sd">        Канал Redis для отправки сообщений: ``axiomLowLevelCommunication:info:metrics_data``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for input_unit_addr in self.hardware_units:</span>
        <span class="c1">#</span>
        <span class="c1">#     # Считаем напряжение на модуле ввода</span>
        <span class="c1">#     voltage_sample = int(self.input_units_state_dicts[input_unit_addr][&#39;adc&#39;][&#39;sample&#39;])</span>
        <span class="c1">#</span>
        <span class="c1">#     Um = abs(voltage_sample * (3/4096) - 1.5) * 253.557     # амплитудное значение напряжения</span>
        <span class="c1">#     U = Um * 0.707                                          # действующее значение напряжения</span>
        <span class="c1">#</span>
        <span class="c1">#     # Публикуем рассчитанное значение</span>
        <span class="c1">#     voltage_message = {&#39;U&#39;: U, &#39;addr&#39;: input_unit_addr, &#39;timestamp&#39;: time.time()}</span>
        <span class="c1">#</span>
        <span class="c1">#     self.r.publish(channel=&#39;axiomLowLevelCommunication:info:voltage&#39;,</span>
        <span class="c1">#                    message=json.dumps(voltage_message))</span>

        <span class="c1"># for input_unit_addr in self.input_unit_addrs:</span>
        <span class="c1">#     U = self.input_units_state_dicts[input_unit_addr][&#39;volt&#39;][&#39;Vin&#39;]</span>
        <span class="c1">#     F = self.input_units_state_dicts[input_unit_addr][&#39;volt&#39;][&#39;freq&#39;]</span>
        <span class="c1">#     P_own = self.calc_system_own_power(input_unit_addr)</span>
        <span class="c1">#</span>
        <span class="c1">#     metrics_data = {&#39;U&#39;: U, &#39;F&#39;: F, &#39;P_own&#39;: P_own, &#39;addr&#39;: input_unit_addr}</span>
        <span class="c1">#</span>
        <span class="c1">#     self.r.publish(channel=&#39;axiomLowLevelCommunication:info:metrics_data&#39;,</span>
        <span class="c1">#                    message=ujson.dumps(metrics_data))</span>

        <span class="n">U</span> <span class="o">=</span> <span class="mi">220</span>

        <span class="k">for</span> <span class="n">power_unit_addr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_unit_addrs</span><span class="p">:</span>
            <span class="c1"># Значения температур каналов силовых модулей</span>
            <span class="n">T1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">][</span><span class="s1">&#39;tmpr&#39;</span><span class="p">][</span><span class="s1">&#39;temp1&#39;</span><span class="p">])</span>
            <span class="n">T2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">][</span><span class="s1">&#39;tmpr&#39;</span><span class="p">][</span><span class="s1">&#39;temp2&#39;</span><span class="p">])</span>

            <span class="c1"># Действующее значение тока</span>
            <span class="n">I1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">][</span><span class="s1">&#39;adc&#39;</span><span class="p">][</span><span class="s1">&#39;sample1&#39;</span><span class="p">])</span>
            <span class="n">I2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">][</span><span class="s1">&#39;adc&#39;</span><span class="p">][</span><span class="s1">&#39;sample2&#39;</span><span class="p">])</span>

            <span class="n">angle1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">][</span><span class="s1">&#39;ld&#39;</span><span class="p">][</span><span class="s1">&#39;angle1&#39;</span><span class="p">])</span>
            <span class="n">angle2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power_units_state_dicts</span><span class="p">[</span><span class="n">power_unit_addr</span><span class="p">][</span><span class="s1">&#39;ld&#39;</span><span class="p">][</span><span class="s1">&#39;angle2&#39;</span><span class="p">])</span>

            <span class="c1"># # Амплитудное значение тока в первом и втором каналах</span>
            <span class="c1"># Im1 = (abs(1.5 - (3 * current_sample1 / 4096)) / 0.066)</span>
            <span class="c1"># Im2 = (abs(1.5 - (3 * current_sample2 / 4096)) / 0.066)</span>
            <span class="c1">#</span>
            <span class="c1"># # Действующее значение тока в первом и втором каналах</span>
            <span class="c1"># I1 = Im1 * 0.707</span>
            <span class="c1"># I2 = Im2 * 0.707</span>

            <span class="c1"># Фазовый сдвиг в первом и втором каналах</span>
            <span class="n">phi1</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">80</span>
            <span class="n">phi2</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">80</span>

            <span class="c1"># Активная мощность потребляемая мощность в первом и втором каналах</span>
            <span class="n">Pa1</span> <span class="o">=</span> <span class="n">U</span> <span class="o">*</span> <span class="n">I1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi1</span><span class="p">)</span>
            <span class="n">Pa2</span> <span class="o">=</span> <span class="n">U</span> <span class="o">*</span> <span class="n">I2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi2</span><span class="p">)</span>
            <span class="c1"># print(&#39;Мощность1: {}, Фи1: {}, Ток1: {}, Косинус1: {}&#39;.format(Pa1, phi1, I1, math.cos(phi1)))</span>
            <span class="c1"># print(&#39;Мощность2: {}, Фи2: {}, Ток2: {}, Косинус2: {}&#39;.format(Pa2, phi2, I2, math.cos(phi2)))</span>
            <span class="c1"># print()</span>

            <span class="c1"># Реактивная потребляемая мощность в первом и втором каналах</span>
            <span class="n">Pr1</span> <span class="o">=</span> <span class="n">U</span> <span class="o">*</span> <span class="n">I1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi1</span><span class="p">)</span>
            <span class="n">Pr2</span> <span class="o">=</span> <span class="n">U</span> <span class="o">*</span> <span class="n">I2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi2</span><span class="p">)</span>

            <span class="c1"># Полная потребляемая мощности в первом и втором каналах</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="n">U</span> <span class="o">*</span> <span class="n">I1</span>
            <span class="n">P2</span> <span class="o">=</span> <span class="n">U</span> <span class="o">*</span> <span class="n">I2</span>

            <span class="c1"># Частота на модуле</span>
            <span class="c1"># F = int(self.power_units_state_dicts[power_unit_addr][&#39;adc&#39;][&#39;freq&#39;])</span>
            <span class="n">F</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Публикуем рассчитанные значения потребления и тока</span>
            <span class="n">active_power_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;P1&#39;</span><span class="p">:</span> <span class="n">Pa1</span><span class="p">,</span> <span class="s1">&#39;P2&#39;</span><span class="p">:</span> <span class="n">Pa2</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">:</span> <span class="n">power_unit_addr</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>

            <span class="n">reactive_power_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;P1&#39;</span><span class="p">:</span> <span class="n">Pr1</span><span class="p">,</span> <span class="s1">&#39;P2&#39;</span><span class="p">:</span> <span class="n">Pr2</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">:</span> <span class="n">power_unit_addr</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>

            <span class="n">current_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I1&#39;</span><span class="p">:</span> <span class="n">I1</span><span class="p">,</span> <span class="s1">&#39;I2&#39;</span><span class="p">:</span> <span class="n">I2</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">:</span> <span class="n">power_unit_addr</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>

            <span class="n">frequency_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="n">F</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">:</span> <span class="n">power_unit_addr</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;axiomLowLevelCommunication:info:active_power&#39;</span><span class="p">,</span>
                               <span class="n">message</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">active_power_message</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;axiomLowLevelCommunication:info:reactive_power&#39;</span><span class="p">,</span>
                               <span class="n">message</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">reactive_power_message</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;axiomLowLevelCommunication:info:current&#39;</span><span class="p">,</span>
                               <span class="n">message</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">current_message</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;axiomLowLevelCommunication:info:frequency&#39;</span><span class="p">,</span>
                               <span class="n">message</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">frequency_message</span><span class="p">))</span>

            <span class="n">characteristics_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Pa1&#39;</span><span class="p">:</span> <span class="n">Pa1</span><span class="p">,</span> <span class="s1">&#39;Pa2&#39;</span><span class="p">:</span> <span class="n">Pa2</span><span class="p">,</span> <span class="s1">&#39;Pr1&#39;</span><span class="p">:</span> <span class="n">Pr1</span><span class="p">,</span> <span class="s1">&#39;Pr2&#39;</span><span class="p">:</span> <span class="n">Pr2</span><span class="p">,</span> <span class="s1">&#39;I1&#39;</span><span class="p">:</span> <span class="n">I1</span><span class="p">,</span> <span class="s1">&#39;I2&#39;</span><span class="p">:</span> <span class="n">I2</span><span class="p">,</span>
                                    <span class="s1">&#39;T1&#39;</span><span class="p">:</span> <span class="n">T1</span><span class="p">,</span> <span class="s1">&#39;T2&#39;</span><span class="p">:</span> <span class="n">T2</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">U</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="n">F</span><span class="p">,</span> <span class="s1">&#39;addr&#39;</span><span class="p">:</span> <span class="n">power_unit_addr</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s1">&#39;axiomLowLevelCommunication:info:metrics_data&#39;</span><span class="p">,</span>
                               <span class="n">message</span><span class="o">=</span><span class="n">ujson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">characteristics_dict</span><span class="p">))</span></div>

<div class="viewcode-block" id="HighLowTransceiver.calc_passive_consumption"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.calc_passive_consumption">[документация]</a>    <span class="k">def</span> <span class="nf">calc_passive_consumption</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Расчет пассивной потребляемой мощности схемы</span>
<span class="sd">        в режиме ожидания</span>

<span class="sd">        :deprecated:</span>
<span class="sd">        :return: пассивная потребляемая мощность</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">P_chassis</span> <span class="o">=</span> <span class="mf">3.3</span> <span class="o">*</span> <span class="mf">0.033</span>  <span class="c1"># мощность, потребляемая пассивными элементами монтажа на шасси</span>
        <span class="n">P_controller</span> <span class="o">=</span> <span class="mf">0.308</span>  <span class="c1"># мощность, потребляемая использованным микроконтроллером</span>
        <span class="n">P_relay1</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># мощность, потребляемая реле К1..К16 на шасси</span>
        <span class="n">P_transformer</span> <span class="o">=</span> <span class="mf">0.35</span>  <span class="c1"># мощность, потребляемая трасформатором TV1</span>
        <span class="n">P_relay_input</span> <span class="o">=</span> <span class="mf">0.31</span>  <span class="c1"># мощность, потребляемая реле ввода K17</span>
        <span class="n">P_power_supply</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># мощность, потребляемая блоком питания шасси U1, U2</span>
        <span class="n">P_transistor</span> <span class="o">=</span> <span class="mf">0.15</span>  <span class="c1"># мощность, потребляемая тразисторами VT1, VT2 в восьми розеточных автоматах</span>
        <span class="n">P_automatic</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># мощность, потребляемая автоматом управления</span>

        <span class="c1"># Полная пассивная потребляемая мощность</span>
        <span class="n">P_passive</span> <span class="o">=</span> <span class="n">P_chassis</span> <span class="o">+</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">P_controller</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">P_relay1</span> <span class="o">+</span> <span class="n">P_transformer</span> <span class="o">+</span> <span class="n">P_relay_input</span> <span class="o">+</span> \
                    <span class="mi">2</span> <span class="o">*</span> <span class="n">P_power_supply</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">P_transistor</span> <span class="o">+</span> <span class="n">P_automatic</span>

        <span class="k">return</span> <span class="n">P_passive</span></div>

<div class="viewcode-block" id="HighLowTransceiver.calc_system_own_power"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.calc_system_own_power">[документация]</a>    <span class="k">def</span> <span class="nf">calc_system_own_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_unit_addr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Рассчитывает собственную (без учета потребителей) мощность</span>
<span class="sd">        расходуемую платой, на которой установлен модуль ввода</span>

<span class="sd">        Расчет производится по формуле :math:`P = U_{in} \cdot I_{in} + U_{in} \cdot I_{out} + U_{in} \cdot I_{ypr}`, где</span>

<span class="sd">        * :math:`U_{in}` - действующее значение напряжение сети [В];</span>
<span class="sd">        * :math:`I_{in}` - значение тока, потребляемого внутренними модулями модуля ввода [A];</span>
<span class="sd">        * :math:`I_{out}` - значение тока, потребляемого внешними модулями [A];</span>
<span class="sd">        * :math:`I_{ypr}` - значение тока, потребляемого автоматом управления [A].</span>

<span class="sd">        :type input_unit_addr: str</span>
<span class="sd">        :param input_unit_addr: адрес модуля ввода</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        :return: рассчитанная мощность [Вт]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Vin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_units_state_dicts</span><span class="p">[</span><span class="n">input_unit_addr</span><span class="p">][</span><span class="s1">&#39;volt&#39;</span><span class="p">][</span><span class="s1">&#39;Vin&#39;</span><span class="p">])</span>
        <span class="n">Iin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_units_state_dicts</span><span class="p">[</span><span class="n">input_unit_addr</span><span class="p">][</span><span class="s1">&#39;cur&#39;</span><span class="p">][</span><span class="s1">&#39;Iin&#39;</span><span class="p">])</span>
        <span class="n">Iout</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_units_state_dicts</span><span class="p">[</span><span class="n">input_unit_addr</span><span class="p">][</span><span class="s1">&#39;cur&#39;</span><span class="p">][</span><span class="s1">&#39;Iout&#39;</span><span class="p">])</span>
        <span class="n">Iypr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_units_state_dicts</span><span class="p">[</span><span class="n">input_unit_addr</span><span class="p">][</span><span class="s1">&#39;cur&#39;</span><span class="p">][</span><span class="s1">&#39;Iypr&#39;</span><span class="p">])</span>

        <span class="n">Pin</span> <span class="o">=</span> <span class="n">Vin</span> <span class="o">*</span> <span class="n">Iin</span>
        <span class="n">Pout</span> <span class="o">=</span> <span class="n">Vin</span> <span class="o">*</span> <span class="n">Iout</span>
        <span class="n">Pypr</span> <span class="o">=</span> <span class="n">Vin</span> <span class="o">*</span> <span class="n">Iypr</span>

        <span class="k">return</span> <span class="n">Pin</span> <span class="o">+</span> <span class="n">Pout</span> <span class="o">+</span> <span class="n">Pypr</span></div>

<div class="viewcode-block" id="HighLowTransceiver.run"><a class="viewcode-back" href="../../highLowTransceiver.html#axiomLowLevelCommunication.highLowTransceiver.HighLowTransceiver.run">[документация]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Запускает основной цикл работы функционального модуля.</span>

<span class="sd">        #. Запускает в потоке метод опроса аппаратных модулей :meth:`reader_target`;</span>
<span class="sd">        #. Запускает выполнение задач планировщика :attr:`scheduler`;</span>
<span class="sd">        #. Запускает в потоке метод обработки команд от модуля &quot;Логика&quot; :meth:`writer_target`.</span>

<span class="sd">        Контролирует рабочее состояние потоков опроса и обработки команд</span>

<span class="sd">        .. figure:: _static/run.png</span>
<span class="sd">           :align: center</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">write_log</span><span class="p">(</span><span class="n">log_msg</span><span class="o">=</span><span class="s1">&#39;Программа запущена&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">isRunning</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># 1. Запуск потока опроса</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reader_target</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># 2. Запуск отправки данных о потреблении в каналах</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># 3. Запуск потока посылки команд</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">writer_target</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># 4. Контроль рабочего состояния опроса и посылки команд</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">isRunning</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reader</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="n">reader</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reader_target</span><span class="p">)</span>
                    <span class="n">reader</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">writer</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="n">writer</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">writer_target</span><span class="p">())</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isRunning</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">transceiver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_addrs_to_transceivers_map</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">transceiver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div></div>


</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Быстрый поиск</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Искать" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Навигация</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Алфавитный указатель"
             >указатель</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">документация функциональный модуль &#34;Взаимодействие с низким уровнем&#34; 0.1</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Код модуля</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Андрей Абраменко.
      Создано с помощью <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.0.
    </div>
  </body>
</html>